            adjustModelTransform(model) {
                const box = new THREE.Box3().setFromObject(model);
                const size = box.getSize(new THREE.Vector3());
                const maxSize = Math.max(size.x, size.y, size.z);
                const scale = 4 / maxSize;
                model.scale.multiplyScalar(scale);
                
                // 中央配置
                box.setFromObject(model);
                const center = box.getCenter(new THREE.Vector3());
                model.position.sub(center);
            }
            
            toggleAutoRotate() {
                this.autoRotate = !this.autoRotate;
                const btn = document.getElementById('autoRotateBtn');
                if (this.autoRotate) {
                    btn.classList.add('active');
                    btn.innerHTML = '⏸️ 停止';
                } else {
                    btn.classList.remove('active');
                    btn.innerHTML = '🔄 自動回転';
                }
            }
            
            resetCamera() {
                this.camera.position.set(6, 4, 6);
                this.camera.lookAt(0, 0, 0);
                if (this.currentModel) {
                    this.currentModel.rotation.set(0, 0, 0);
                }
            }
            
            toggleWireframe() {
                this.wireframeMode = !this.wireframeMode;
                const btn = document.getElementById('wireframeBtn');
                
                if (this.currentModel) {
                    this.currentModel.traverse((child) => {
                        if (child.isMesh) {
                            child.material.wireframe = this.wireframeMode;
                        }
                    });
                }
                
                if (this.wireframeMode) {
                    btn.classList.add('active');
                    btn.innerHTML = '🎨 ソリッド';
                } else {
                    btn.classList.remove('active');
                    btn.innerHTML = '📐 ワイヤー';
                }
            }
            
            async switchModel() {
                this.currentModelIndex = (this.currentModelIndex + 1) % this.modelFiles.length;
                await this.loadModel(this.modelFiles[this.currentModelIndex]);
            }
            
            switchLighting() {
                this.currentLightingMode = (this.currentLightingMode + 1) % this.lightingModes.length;
                const mode = this.lightingModes[this.currentLightingMode];
                
                this.directionalLight.intensity = mode.intensity;
                this.directionalLight.color.setHex(mode.color);
                this.rimLight.intensity = mode.intensity * 0.5;
                
                const btn = document.getElementById('lightingBtn');
                btn.innerHTML = `💡 ${mode.name}`;
            }
            
            handleResize() {
                this.camera.aspect = window.innerWidth / window.innerHeight;
                this.camera.updateProjectionMatrix();
                this.renderer.setSize(window.innerWidth, window.innerHeight);
            }
            
            showLoading(text) {
                document.getElementById('loadingOverlay').style.display = 'flex';
                document.getElementById('loadingText').textContent = text;
                document.getElementById('loadingProgressBar').style.width = '0%';
            }
            
            hideLoading() {
                setTimeout(() => {
                    document.getElementById('loadingOverlay').style.opacity = '0';
                    setTimeout(() => {
                        document.getElementById('loadingOverlay').style.display = 'none';
                        document.getElementById('loadingOverlay').style.opacity = '1';
                    }, 500);
                }, 300);
            }
            
            updateLoadingProgress(percent) {
                document.getElementById('loadingProgressBar').style.width = `${percent}%`;
            }
            
            updatePerformanceStats() {
                this.stats.frameCount++;
                const now = performance.now();
                
                if (now >= this.stats.lastTime + 1000) {
                    this.stats.fps = Math.round((this.stats.frameCount * 1000) / (now - this.stats.lastTime));
                    this.stats.frameCount = 0;
                    this.stats.lastTime = now;
                    
                    // FPS表示更新
                    const fpsElement = document.getElementById('fpsCounter');
                    if (fpsElement) {
                        fpsElement.textContent = this.stats.fps;
                        
                        // FPS に応じて色を変更
                        if (this.stats.fps >= 50) {
                            fpsElement.style.color = '#90EE90';
                        } else if (this.stats.fps >= 30) {
                            fpsElement.style.color = '#FFA500';
                        } else {
                            fpsElement.style.color = '#FF6347';
                        }
                    }
                    
                    // ポリゴン数表示
                    const polygonElement = document.getElementById('polygonCounter');
                    if (polygonElement && this.currentModel) {
                        let triangles = 0;
                        this.currentModel.traverse((child) => {
                            if (child.isMesh && child.geometry) {
                                triangles += child.geometry.attributes.position.count / 3;
                            }
                        });
                        polygonElement.textContent = Math.round(triangles).toLocaleString();
                    }
                    
                    // 描画コール数表示
                    const drawCallElement = document.getElementById('drawCallCounter');
                    if (drawCallElement) {
                        drawCallElement.textContent = this.renderer.info.render.calls;
                    }
                }
            }
            
            startAnimationLoop() {
                const animate = () => {
                    requestAnimationFrame(animate);
                    
                    // 自動回転
                    if (this.autoRotate && this.currentModel) {
                        this.currentModel.rotation.y += 0.01 * this.rotationSpeed;
                        this.currentModel.rotation.x += 0.005 * this.rotationSpeed;
                    }
                    
                    // カメラの軽微な浮遊効果
                    const time = Date.now() * 0.001;
                    this.camera.position.y += Math.sin(time * 0.5) * 0.01;
                    
                    // 照明の動的効果
                    if (this.directionalLight) {
                        this.directionalLight.position.x = Math.sin(time * 0.3) * 2 + 10;
                        this.directionalLight.position.z = Math.cos(time * 0.3) * 2 + 5;
                    }
                    
                    // レンダリング
                    this.renderer.render(this.scene, this.camera);
                    
                    // パフォーマンス統計更新
                    this.updatePerformanceStats();
                };
                
                animate();
            }
        }
        
        // アプリケーション初期化
        document.addEventListener('DOMContentLoaded', () => {
            // 互換性チェック
            if (!window.WebGLRenderingContext) {
                alert('お使いのブラウザはWebGLに対応していません。');
                return;
            }
            
            // パフォーマンス最適化のための設定
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('/sw.js').catch(() => {
                    // Service Worker の登録失敗は無視
                });
            }
            
            // デバイス別最適化
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            if (isMobile) {
                document.body.classList.add('mobile-device');
                // モバイル用最適化
                document.getElementById('performancePanel').style.display = 'none';
            }
            
            // アプリケーション開始
            window.sudachiViewer = new SudachiViewer();
            
            // エラーハンドリング
            window.addEventListener('error', (e) => {
                console.error('アプリケーションエラー:', e.error);
            });
            
            // デバッグ情報（開発用）
            if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                console.log('🍃 スダチ 3D ビューワー - デバッグモード');
                console.log('Three.js バージョン:', THREE.REVISION);
                console.log('WebGL バージョン:', window.sudachiViewer?.renderer?.getContext().getParameter(window.sudachiViewer.renderer.getContext().VERSION));
            }
        });
        
        // ユーティリティ関数
        function isMobileDevice() {
            return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        }
        
        function getWebGLSupport() {
            try {
                const canvas = document.createElement('canvas');
                return !!(window.WebGLRenderingContext && canvas.getContext('webgl'));
            } catch (e) {
                return false;
            }
        }
        
        // キーボードショートカット
        document.addEventListener('keydown', (e) => {
            if (!window.sudachiViewer) return;
            
            switch(e.key.toLowerCase()) {
                case 'r':
                    e.preventDefault();
                    window.sudachiViewer.resetCamera();
                    break;
                case 'w':
                    e.preventDefault();
                    window.sudachiViewer.toggleWireframe();
                    break;
                case 'a':
                    e.preventDefault();
                    window.sudachiViewer.toggleAutoRotate();
                    break;
                case 'm':
                    e.preventDefault();
                    window.sudachiViewer.switchModel();
                    break;
                case 'l':
                    e.preventDefault();
                    window.sudachiViewer.switchLighting();
                    break;
                case ' ':
                    e.preventDefault();
                    window.sudachiViewer.toggleAutoRotate();
                    break;
            }
        });
        
        // パフォーマンスモニタリング
        if ('performance' in window) {
            window.addEventListener('load', () => {
                setTimeout(() => {
                    const loadTime = performance.timing.loadEventEnd - performance.timing.navigationStart;
                    console.log(`🚀 ページ読み込み時間: ${loadTime}ms`);
                }, 0);
            });
        }
    </script>
</body>
</html>